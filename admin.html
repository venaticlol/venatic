<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Recon Spoofer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000000;
            background-image: 
                linear-gradient(rgba(42, 42, 42, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(42, 42, 42, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            background-position: 0 0, 0 0;
            color: #e5e5e5;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(42, 42, 42, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(42, 42, 42, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            background-position: 0 0, 0 0;
            pointer-events: none;
            z-index: 0;
        }

        /* Container */
        .admin-container {
            position: relative;
            z-index: 2;
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Header */
        .admin-header {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 4px;
            padding: 25px 35px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .admin-header:hover {
            border-color: #2a2a2a;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
        }

        .admin-header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .admin-logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 800;
            transition: all 0.3s ease;
        }

        .admin-header:hover .admin-logo {
            border-color: #4a4a4a;
            transform: scale(1.05);
        }

        .admin-header-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff 0%, #b0b0b0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .admin-header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .admin-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-btn-primary {
            background: #1a1a1a;
            border: 1px solid #4a4a4a;
            color: #e5e5e5;
        }

        .admin-btn-primary:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
            border-color: #6a6a6a;
            background: #222222;
        }

        .admin-btn-danger {
            background: #1a1a1a;
            border: 1px solid #4a4a4a;
            color: #e5e5e5;
        }

        .admin-btn-danger:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
            border-color: #6a6a6a;
            background: #222222;
        }

        /* Tabs */
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: #0a0a0a;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #1a1a1a;
            position: relative;
            z-index: 1;
        }

        .admin-tab {
            flex: 1;
            padding: 14px 24px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: #888;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .admin-tab.active {
            background: #1a1a1a;
            color: #e5e5e5;
            border: 1px solid #3a3a3a;
        }

        .admin-tab:hover:not(.active) {
            color: #e5e5e5;
            background: rgba(26, 26, 26, 0.5);
        }

        /* Content Cards */
        .admin-content-card {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 4px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .admin-content-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.03), transparent);
            transition: left 0.6s;
        }

        .admin-content-card:hover::before {
            left: 100%;
        }

        .admin-content-card:hover {
            border-color: #2a2a2a;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
        }

        .admin-content-card h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #e5e5e5;
        }

        /* Table */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }

        .admin-table thead {
            background: #1a1a1a;
        }

        .admin-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #888;
            border-bottom: 1px solid #2a2a2a;
        }

        .admin-table td {
            padding: 18px 15px;
            border-bottom: 1px solid #1a1a1a;
            color: #e5e5e5;
            font-size: 14px;
        }

        .admin-table tbody tr {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .admin-table tbody tr:hover {
            background: rgba(26, 26, 26, 0.5);
        }

        .admin-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-view {
            background: #1a1a1a;
            color: #e5e5e5;
            border: 1px solid #4a4a4a;
        }

        .btn-view:hover {
            background: #222222;
            border-color: #6a6a6a;
            transform: translateY(-2px);
            transform: translateY(-1px);
        }

        .btn-blacklist {
            background: #1a1a1a;
            color: #ef4444;
            border: 1px solid #4a4a4a;
        }

        .btn-blacklist:hover {
            background: #222222;
            border-color: #6a6a6a;
            transform: translateY(-2px);
        }

        .btn-unblacklist {
            background: #1a1a1a;
            color: #22c55e;
            border: 1px solid #4a4a4a;
        }

        .btn-unblacklist:hover {
            background: #222222;
            border-color: #6a6a6a;
            transform: translateY(-2px);
        }

        .btn-delete {
            background: #1a1a1a;
            color: #ef4444;
            border: 1px solid #4a4a4a;
        }

        .btn-delete:hover {
            background: #222222;
            border-color: #6a6a6a;
            transform: translateY(-2px);
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-blacklisted {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.98) 0%, rgba(37, 37, 37, 0.98) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 22px;
            font-weight: 700;
            color: #e5e5e5;
        }

        .modal-close {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #ef4444;
            font-size: 24px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: scale(1.05);
        }

        .modal-body {
            color: #e5e5e5;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(74, 74, 74, 0.3);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #888;
            font-weight: 600;
        }

        .info-value {
            color: #e5e5e5;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 16px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #e5e5e5;
            font-weight: 600;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(74, 74, 74, 0.6);
            border-radius: 8px;
            color: #e5e5e5;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(0, 0, 0, 0.6);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        .form-input textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Changelog Changes List */
        .changelog-change-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(74, 74, 74, 0.5);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .changelog-change-item-text {
            flex: 1;
            color: #e5e5e5;
            font-size: 14px;
        }

        .changelog-change-item-remove {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 4px;
            padding: 4px 8px;
            color: #ef4444;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .changelog-change-item-remove:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-container {
                padding: 15px;
            }

            .admin-header {
                flex-direction: column;
                gap: 15px;
            }

            .admin-tabs {
                flex-direction: column;
            }

            .admin-table {
                font-size: 12px;
            }

            .admin-table th,
            .admin-table td {
                padding: 10px 8px;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Header -->
        <div class="admin-header">
            <div class="admin-header-left">
                <div class="admin-logo">‚ö°</div>
                <div class="admin-header-title">Admin Control Panel</div>
            </div>
            <div class="admin-header-right">
                <button class="admin-btn admin-btn-primary" onclick="window.location.href='/'">
                    ‚Üê Back to Site
                </button>
                <button class="admin-btn admin-btn-danger" onclick="logout()">
                    Logout
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="announcements">Announcements</button>
            <button class="admin-tab" data-tab="changelog">Changelog</button>
            <button class="admin-tab" data-tab="reviews">Reviews</button>
            <button class="admin-tab" data-tab="users">Users</button>
            <button class="admin-tab" data-tab="blacklisted">Blacklisted</button>
            <button class="admin-tab" data-tab="maintenance">Maintenance</button>
            <button class="admin-tab" data-tab="backup">Backup & Restore</button>
            <button class="admin-tab" data-tab="surveys">Surveys & Polls</button>
            <button class="admin-tab" data-tab="webhooks">Discord Webhooks</button>
            <button class="admin-tab" data-tab="tickets">Tickets</button>
        </div>

        <!-- Announcements Tab -->
        <div class="admin-content-card" id="tabAnnouncements">
            <h2>Announcements Management</h2>
            <button class="admin-btn admin-btn-primary" style="margin-bottom: 20px;" onclick="editAnnouncement(null)">+ Add Announcement</button>
            <div id="announcementsContent">
                <div class="loading">Loading announcements...</div>
            </div>
        </div>

        <!-- Changelog Tab -->
        <div class="admin-content-card" id="tabChangelog" style="display: none;">
            <h2>Changelog Management</h2>
            <button class="admin-btn admin-btn-primary" style="margin-bottom: 20px;" onclick="editChangelog(null)">+ Add Changelog Entry</button>
            <div id="changelogContent">
                <div class="loading">Loading changelog...</div>
            </div>
        </div>

        <!-- Reviews Tab -->
        <div class="admin-content-card" id="tabReviews" style="display: none;">
            <h2>Reviews Management</h2>
            <div id="reviewsContent">
                <div class="loading">Loading reviews...</div>
            </div>
        </div>

        <!-- Users Tab -->
        <div class="admin-content-card" id="tabUsers" style="display: none;">
            <h2>User Management</h2>
            <div id="usersContent">
                <div class="loading">Loading users...</div>
            </div>
        </div>

        <!-- Blacklisted Users Tab -->
        <div class="admin-content-card" id="tabBlacklisted" style="display: none;">
            <h2>Blacklisted Users</h2>
            <div id="blacklistedContent">
                <div class="loading">Loading blacklisted users...</div>
            </div>
        </div>

        <!-- Maintenance Tab -->
        <div class="admin-content-card" id="tabMaintenance" style="display: none;">
            <h2>Maintenance Mode</h2>
            <div id="maintenanceContent">
                <div class="loading">Loading maintenance settings...</div>
            </div>
        </div>

        <!-- Backup & Restore Tab -->
        <div class="admin-content-card" id="tabBackup" style="display: none;">
            <h2>Backup & Restore</h2>
            <div id="backupContent">
                <div class="loading">Loading backup tools...</div>
            </div>
        </div>

        <!-- Surveys & Polls Tab -->
        <div class="admin-content-card" id="tabSurveys" style="display: none;">
            <h2>Surveys & Polls Management</h2>
            <button class="admin-btn admin-btn-primary" style="margin-bottom: 20px;" onclick="editSurvey(null)">+ Create Survey/Poll</button>
            <div id="surveysContent">
                <div class="loading">Loading surveys...</div>
            </div>
        </div>

        <!-- Discord Webhooks Tab -->
        <div class="admin-content-card" id="tabWebhooks" style="display: none;">
            <h2>Discord Webhook Integration</h2>
            <button class="admin-btn admin-btn-primary" style="margin-bottom: 20px;" onclick="createWebhook()">+ Create Webhook</button>
            <div id="webhooksContent">
                <div class="loading">Loading webhooks...</div>
            </div>
        </div>

        <!-- Tickets Tab -->
        <div class="admin-content-card" id="tabTickets" style="display: none;">
            <h2>Support Tickets</h2>
            <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                <select id="ticketFilterStatus" class="form-input" style="flex: 1; min-width: 150px;" onchange="loadTickets()">
                    <option value="all">All Status</option>
                    <option value="open">Open</option>
                    <option value="closed">Closed</option>
                </select>
                <input type="text" id="ticketSearchInput" class="form-input" placeholder="Search tickets..." style="flex: 2; min-width: 200px;" oninput="loadTickets()">
            </div>
            <div id="ticketsContent">
                <div class="loading">Loading tickets...</div>
            </div>
        </div>
    </div>

    <!-- User Info Modal -->
    <div class="modal" id="userInfoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>User Information</h3>
                <button class="modal-close" onclick="closeModal('userInfoModal')">√ó</button>
            </div>
            <div class="modal-body" id="userInfoContent">
                <!-- User info will be populated here -->
            </div>
        </div>
    </div>

    <!-- Announcement Editor Modal -->
    <div class="modal" id="announcementEditorModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="announcementEditorTitle">Add Announcement</h3>
                <button class="modal-close" onclick="hideAnnouncementEditor()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="announcementTitleInput" class="form-input" placeholder="New Update Available!" maxlength="100">
                </div>
                <div class="form-group">
                    <label>Message *</label>
                    <textarea id="announcementMessageInput" class="form-input" rows="4" placeholder="Version 1.2.0 is now live with exciting new features." maxlength="500"></textarea>
                </div>
                <div class="form-group">
                    <label>Type *</label>
                    <select id="announcementTypeInput" class="form-input">
                        <option value="info">Info (Blue)</option>
                        <option value="success">Success (Green)</option>
                        <option value="warning">Warning (Orange)</option>
                        <option value="error">Error (Red)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Priority *</label>
                    <select id="announcementPriorityInput" class="form-input">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>End Date (Optional)</label>
                    <input type="datetime-local" id="announcementEndDateInput" class="form-input">
                    <div style="font-size: 12px; color: #888; margin-top: 4px;">Leave empty to show indefinitely</div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="announcementDismissibleInput" checked> Dismissible (users can close)
                    </label>
                </div>
                <div class="form-group">
                    <label>Link URL (Optional)</label>
                    <input type="url" id="announcementLinkInput" class="form-input" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>Link Text (Optional)</label>
                    <input type="text" id="announcementLinkTextInput" class="form-input" placeholder="Learn More">
                </div>
                <div id="announcementEditorError" style="color: #ef4444; font-size: 13px; margin-bottom: 16px; display: none;"></div>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button class="admin-btn admin-btn-primary" onclick="saveAnnouncement()" style="flex: 1;">Save Announcement</button>
                    <button class="admin-btn" onclick="hideAnnouncementEditor()" style="flex: 1; background: rgba(74, 74, 74, 0.3);">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Changelog Editor Modal -->
    <div class="modal" id="changelogEditorModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="changelogEditorTitle">Add Changelog Entry</h3>
                <button class="modal-close" onclick="hideChangelogEditor()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Version *</label>
                    <input type="text" id="changelogVersionInput" class="form-input" placeholder="1.2.0" maxlength="20">
                </div>
                <div class="form-group">
                    <label>Release Date *</label>
                    <input type="date" id="changelogDateInput" class="form-input">
                </div>
                <div class="form-group">
                    <label>Type (Optional)</label>
                    <select id="changelogTypeInput" class="form-input">
                        <option value="">None</option>
                        <option value="major">Major</option>
                        <option value="minor">Minor</option>
                        <option value="patch">Patch</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Download URL (Optional)</label>
                    <input type="url" id="changelogDownloadUrlInput" class="form-input" placeholder="https://github.com/.../releases/tag/v1.2.0">
                </div>
                <div class="form-group">
                    <label>Changes *</label>
                    <div id="changelogChangesList" style="margin-bottom: 12px;"></div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="changelogChangeInput" class="form-input" placeholder="Added new feature..." style="flex: 1;" maxlength="200">
                        <button type="button" class="btn-action btn-view" onclick="addChangelogChange()" style="white-space: nowrap;">+ Add</button>
                    </div>
                    <div style="font-size: 12px; color: #888; margin-top: 4px;">Add each change as a separate item</div>
                </div>
                <div id="changelogEditorError" style="color: #ef4444; font-size: 13px; margin-bottom: 16px; display: none;"></div>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button class="admin-btn admin-btn-primary" onclick="saveChangelog()" style="flex: 1;">Save Changelog</button>
                    <button class="admin-btn" onclick="hideChangelogEditor()" style="flex: 1; background: rgba(74, 74, 74, 0.3);">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Blacklist Editor Modal -->
    <div class="modal" id="blacklistEditorModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="blacklistEditorTitle">Blacklist User</h3>
                <button class="modal-close" onclick="closeBlacklistModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>IP Address *</label>
                    <input type="text" id="blacklistIpInput" class="form-input" placeholder="192.168.1.1" readonly>
                </div>
                <div class="form-group">
                    <label>Reason *</label>
                    <select id="blacklistReasonInput" class="form-input">
                        <option value="Spam">Spam</option>
                        <option value="Abuse">Abuse</option>
                        <option value="Suspicious Activity">Suspicious Activity</option>
                        <option value="Terms Violation">Terms Violation</option>
                        <option value="Other" selected>Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="blacklistNotesInput" class="form-input" rows="4" placeholder="Additional details about why this user was blacklisted..."></textarea>
                </div>
                <div id="blacklistError" style="color: #ef4444; font-size: 13px; margin-bottom: 16px; display: none;"></div>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button class="admin-btn admin-btn-danger" onclick="saveBlacklist()" style="flex: 1;">Blacklist User</button>
                    <button class="admin-btn" onclick="closeBlacklistModal()" style="flex: 1; background: rgba(74, 74, 74, 0.3);">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Survey Editor Modal -->
    <div class="modal" id="surveyEditorModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="surveyEditorTitle">Create Survey/Poll</h3>
                <button class="modal-close" onclick="hideSurveyEditor()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="surveyTitleInput" class="form-input" placeholder="What do you think about our new feature?" maxlength="200">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="surveyDescriptionInput" class="form-input" rows="3" placeholder="Share your thoughts..." maxlength="500"></textarea>
                </div>
                <div class="form-group">
                    <label>Type *</label>
                    <select id="surveyTypeInput" class="form-input">
                        <option value="poll">Poll (Single Choice)</option>
                        <option value="survey">Survey (Multiple Choice)</option>
                        <option value="rating">Rating (1-5 Stars)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Options *</label>
                    <div id="surveyOptionsList" style="margin-bottom: 12px;"></div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="surveyOptionInput" class="form-input" placeholder="Enter option..." style="flex: 1;" maxlength="100">
                        <button type="button" class="btn-action btn-view" onclick="addSurveyOption()" style="white-space: nowrap;">+ Add</button>
                    </div>
                    <div style="font-size: 12px; color: #888; margin-top: 4px;">Add at least 2 options</div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="surveyActiveInput" checked> Active (visible on site)
                    </label>
                </div>
                <div id="surveyEditorError" style="color: #ef4444; font-size: 13px; margin-bottom: 16px; display: none;"></div>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button class="admin-btn admin-btn-primary" onclick="saveSurvey()" style="flex: 1;">Save Survey</button>
                    <button class="admin-btn" onclick="hideSurveyEditor()" style="flex: 1; background: rgba(74, 74, 74, 0.3);">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Discord Webhook Editor Modal -->
    <div class="modal" id="webhookEditorModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="webhookEditorTitle">Create Discord Webhook</h3>
                <button class="modal-close" onclick="hideWebhookEditor()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Webhook Name *</label>
                    <input type="text" id="webhookNameInput" class="form-input" placeholder="My Webhook" maxlength="100">
                </div>
                <div class="form-group">
                    <label>Webhook URL *</label>
                    <input type="url" id="webhookUrlInput" class="form-input" placeholder="https://discord.com/api/webhooks/..." maxlength="500">
                    <div style="font-size: 12px; color: #888; margin-top: 4px;">Get your webhook URL from Discord channel settings</div>
                </div>
                
                <div style="border-top: 1px solid #2a2a2a; margin: 20px 0; padding-top: 20px;">
                    <h4 style="color: #e5e5e5; margin-bottom: 16px;">Embed Builder</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <div class="form-group">
                                <label>Title</label>
                                <input type="text" id="embedTitleInput" class="form-input" placeholder="Embed Title" maxlength="256">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="embedDescriptionInput" class="form-input" rows="4" placeholder="Embed description..." maxlength="4096"></textarea>
                            </div>
                            <div class="form-group">
                                <label>URL (makes title clickable)</label>
                                <input type="url" id="embedUrlInput" class="form-input" placeholder="https://..." maxlength="500">
                            </div>
                            <div class="form-group">
                                <label>Color</label>
                                <input type="color" id="embedColorInput" class="form-input" value="#5865F2" style="height: 40px;">
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label>Author Name</label>
                                <input type="text" id="embedAuthorNameInput" class="form-input" placeholder="Author" maxlength="256">
                            </div>
                            <div class="form-group">
                                <label>Author Icon URL</label>
                                <input type="url" id="embedAuthorIconInput" class="form-input" placeholder="https://..." maxlength="500">
                            </div>
                            <div class="form-group">
                                <label>Footer Text</label>
                                <input type="text" id="embedFooterInput" class="form-input" placeholder="Footer" maxlength="2048">
                            </div>
                            <div class="form-group">
                                <label>Footer Icon URL</label>
                                <input type="url" id="embedFooterIconInput" class="form-input" placeholder="https://..." maxlength="500">
                            </div>
                            <div class="form-group">
                                <label>Thumbnail URL</label>
                                <input type="url" id="embedThumbnailInput" class="form-input" placeholder="https://..." maxlength="500">
                            </div>
                            <div class="form-group">
                                <label>Image URL</label>
                                <input type="url" id="embedImageInput" class="form-input" placeholder="https://..." maxlength="500">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Fields</label>
                        <div id="embedFieldsList" style="margin-bottom: 12px;"></div>
                        <button type="button" class="btn-action btn-view" onclick="addEmbedField()" style="margin-bottom: 12px;">+ Add Field</button>
                    </div>
                    
                    <div class="form-group">
                        <label>Timestamp</label>
                        <select id="embedTimestampInput" class="form-input">
                            <option value="none">None</option>
                            <option value="now" selected>Current Time</option>
                            <option value="custom">Custom</option>
                        </select>
                        <input type="datetime-local" id="embedTimestampCustomInput" class="form-input" style="margin-top: 8px; display: none;">
                    </div>
                </div>
                
                <div style="border-top: 1px solid #2a2a2a; margin: 20px 0; padding-top: 20px;">
                    <h4 style="color: #e5e5e5; margin-bottom: 16px;">Preview</h4>
                    <div id="embedPreview" style="background: #2f3136; border-left: 4px solid #5865F2; padding: 16px; border-radius: 4px; margin-bottom: 20px; min-height: 100px;">
                        <div style="color: #dcddde; font-size: 14px;">Preview will appear here...</div>
                    </div>
                    <button type="button" class="admin-btn" onclick="updateEmbedPreview()" style="margin-bottom: 12px;">üîÑ Update Preview</button>
                    <button type="button" class="admin-btn admin-btn-primary" onclick="testWebhook()" style="margin-bottom: 12px;">üì§ Send Test Message</button>
                </div>
                
                <div id="webhookEditorError" style="color: #ef4444; font-size: 13px; margin-bottom: 16px; display: none;"></div>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button class="admin-btn admin-btn-primary" onclick="saveWebhook()" style="flex: 1;">Save Webhook</button>
                    <button class="admin-btn" onclick="hideWebhookEditor()" style="flex: 1; background: rgba(74, 74, 74, 0.3);">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Maintenance Mode Modal -->
    <div class="modal" id="maintenanceModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Configure Maintenance Mode</h3>
                <button class="modal-close" onclick="closeMaintenanceModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="maintenanceEnabled" style="width: 20px; height: 20px; cursor: pointer;"> 
                        <span>Enable Maintenance Mode</span>
                    </label>
                </div>
                <div class="form-group">
                    <label>Maintenance Message *</label>
                    <textarea id="maintenanceMessage" class="form-input" rows="4" placeholder="We're currently performing scheduled maintenance. We'll be back shortly!">We're currently performing scheduled maintenance. We'll be back shortly!</textarea>
                </div>
                <div class="form-group">
                    <label>Estimated Return Time (Optional)</label>
                    <input type="datetime-local" id="maintenanceReturnTime" class="form-input">
                </div>
                <div id="maintenanceError" style="color: #ef4444; font-size: 13px; margin-bottom: 16px; display: none;"></div>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button class="admin-btn admin-btn-primary" onclick="saveMaintenanceSettings()" style="flex: 1;">Save Settings</button>
                    <button class="admin-btn" onclick="closeMaintenanceModal()" style="flex: 1; background: rgba(74, 74, 74, 0.3);">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration (same as index.html)
        const firebaseConfig = {
            apiKey: "AIzaSyC6CrMVEbsr-AADq-w-TOkzO0AAOZtUqmU",
            authDomain: "recon-265bc.firebaseapp.com",
            databaseURL: "https://recon-265bc-default-rtdb.firebaseio.com",
            projectId: "recon-265bc",
            storageBucket: "recon-265bc.firebasestorage.app",
            messagingSenderId: "99005456592",
            appId: "1:99005456592:web:9ca83e210d9e85ca8a3ed5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Check admin session
        const ADMIN_SESSION_KEY = 'recon_admin_session';
        const isAdminLoggedIn = sessionStorage.getItem(ADMIN_SESSION_KEY) === 'true';

        if (!isAdminLoggedIn) {
            window.location.href = '/';
        }

        // Track admin panel visit (optional)
        async function trackUserVisit() {
            // Admin panel visits are tracked but not blocked by blacklist
            try {
                const ip = await getClientIP();
                const userAgent = navigator.userAgent;
                const timestamp = Date.now();
                const visitId = `visit_${timestamp}_${Math.random().toString(36).substr(2, 9)}`;

                const visitData = {
                    ip: ip,
                    userAgent: userAgent,
                    timestamp: timestamp,
                    date: new Date().toISOString(),
                    url: window.location.href,
                    isAdmin: true
                };

                await database.ref(`visits/${visitId}`).set(visitData);
            } catch (error) {
                console.error('Error tracking visit:', error);
            }
        }

        // Get client IP (using a free service)
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                // Fallback to a generated ID
                return 'unknown_' + Math.random().toString(36).substr(2, 9);
            }
        }

        // Load reviews
        async function loadReviews() {
            const content = document.getElementById('reviewsContent');
            try {
                const snapshot = await database.ref('ratings').once('value');
                if (!snapshot.exists()) {
                    content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚≠ê</div><div class="empty-state-text">No reviews yet</div></div>';
                    return;
                }

                const ratings = snapshot.val();
                const reviews = Object.entries(ratings);

                if (reviews.length === 0) {
                    content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚≠ê</div><div class="empty-state-text">No reviews yet</div></div>';
                    return;
                }

                let html = `
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Rating</th>
                                <th>Review</th>
                                <th>Timestamp</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                reviews.forEach(([id, review]) => {
                    const date = new Date(review.timestamp || 0);
                    const stars = '‚≠ê'.repeat(review.rating || 0);
                    html += `
                        <tr>
                            <td>${stars} (${review.rating || 0}/5)</td>
                            <td>${escapeHtml(review.review || 'No review text')}</td>
                            <td>${date.toLocaleString()}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action btn-delete" onclick="deleteReview('${id}')">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                content.innerHTML = html;
            } catch (error) {
                console.error('Error loading reviews:', error);
                content.innerHTML = '<div class="empty-state"><div class="empty-state-text">Error loading reviews</div></div>';
            }
        }

        // Delete review
        async function deleteReview(id) {
            if (!confirm('Are you sure you want to delete this review?')) return;

            try {
                await database.ref(`ratings/${id}`).remove();
                alert('‚úÖ Review deleted successfully!');
                loadReviews();
            } catch (error) {
                console.error('Error deleting review:', error);
                alert('‚ùå Failed to delete review: ' + error.message);
            }
        }

        // Load users
        async function loadUsers() {
            const content = document.getElementById('usersContent');
            try {
                // Load visits
                const visitsSnapshot = await database.ref('visits').once('value');
                // Load blacklist
                const blacklistSnapshot = await database.ref('blacklist').once('value');
                
                const blacklist = blacklistSnapshot.exists() ? blacklistSnapshot.val() : {};
                const visits = visitsSnapshot.exists() ? visitsSnapshot.val() : {};

                // Group visits by IP
                const usersByIP = {};
                Object.entries(visits).forEach(([visitId, visit]) => {
                    const ip = visit.ip || 'unknown';
                    if (!usersByIP[ip]) {
                        usersByIP[ip] = {
                            ip: ip,
                            visits: [],
                            firstVisit: visit.timestamp,
                            lastVisit: visit.timestamp,
                            userAgent: visit.userAgent
                        };
                    }
                    usersByIP[ip].visits.push(visit);
                    if (visit.timestamp < usersByIP[ip].firstVisit) {
                        usersByIP[ip].firstVisit = visit.timestamp;
                    }
                    if (visit.timestamp > usersByIP[ip].lastVisit) {
                        usersByIP[ip].lastVisit = visit.timestamp;
                    }
                });

                const users = Object.values(usersByIP).sort((a, b) => b.lastVisit - a.lastVisit);

                if (users.length === 0) {
                    content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë§</div><div class="empty-state-text">No users yet</div></div>';
                    return;
                }

                let html = `
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>IP Address</th>
                                <th>Visits</th>
                                <th>First Visit</th>
                                <th>Last Visit</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                users.forEach(user => {
                    const ipKey = user.ip.replace(/\./g, '_');
                    const isBlacklisted = blacklist[ipKey] !== undefined;
                    const firstDate = new Date(user.firstVisit).toLocaleString();
                    const lastDate = new Date(user.lastVisit).toLocaleString();
                    
                    html += `
                        <tr>
                            <td>${escapeHtml(user.ip)}</td>
                            <td>${user.visits.length}</td>
                            <td>${firstDate}</td>
                            <td>${lastDate}</td>
                            <td>
                                <span class="status-badge ${isBlacklisted ? 'status-blacklisted' : 'status-active'}">
                                    ${isBlacklisted ? 'Blacklisted' : 'Active'}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action btn-view" onclick="viewUser('${escapeHtml(user.ip)}')">View</button>
                                    ${isBlacklisted 
                                        ? `<button class="btn-action btn-unblacklist" onclick="unblacklistUser('${escapeHtml(user.ip)}')">Unblacklist</button>`
                                        : `<button class="btn-action btn-blacklist" onclick="openBlacklistModal('${escapeHtml(user.ip)}')">Blacklist</button>`
                                    }
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                content.innerHTML = html;
            } catch (error) {
                console.error('Error loading users:', error);
                content.innerHTML = '<div class="empty-state"><div class="empty-state-text">Error loading users</div></div>';
            }
        }

        // View user
        async function viewUser(ip) {
            try {
                const visitsSnapshot = await database.ref('visits').once('value');
                const visits = visitsSnapshot.exists() ? visitsSnapshot.val() : {};
                const userVisits = Object.values(visits).filter(v => v.ip === ip);
                const blacklistSnapshot = await database.ref('blacklist').once('value');
                const blacklist = blacklistSnapshot.exists() ? blacklistSnapshot.val() : {};
                const ipKey = ip.replace(/\./g, '_');
                const isBlacklisted = blacklist[ipKey] !== undefined;

                let html = `
                    <div class="info-row">
                        <span class="info-label">IP Address:</span>
                        <span class="info-value">${escapeHtml(ip)}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status:</span>
                        <span class="info-value">
                            <span class="status-badge ${isBlacklisted ? 'status-blacklisted' : 'status-active'}">
                                ${isBlacklisted ? 'Blacklisted' : 'Active'}
                            </span>
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Total Visits:</span>
                        <span class="info-value">${userVisits.length}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">First Visit:</span>
                        <span class="info-value">${new Date(userVisits[0]?.timestamp || 0).toLocaleString()}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Last Visit:</span>
                        <span class="info-value">${new Date(userVisits[userVisits.length - 1]?.timestamp || 0).toLocaleString()}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">User Agent:</span>
                        <span class="info-value" style="font-size: 12px; word-break: break-all;">${escapeHtml(userVisits[0]?.userAgent || 'Unknown')}</span>
                    </div>
                `;

                document.getElementById('userInfoContent').innerHTML = html;
                document.getElementById('userInfoModal').classList.add('active');
            } catch (error) {
                console.error('Error viewing user:', error);
                alert('Error loading user information');
            }
        }

        // Open blacklist modal
        window.openBlacklistModal = function(ip) {
            document.getElementById('blacklistIpInput').value = ip;
            document.getElementById('blacklistReasonInput').value = 'Other';
            document.getElementById('blacklistNotesInput').value = '';
            document.getElementById('blacklistError').style.display = 'none';
            document.getElementById('blacklistEditorTitle').textContent = 'Blacklist User';
            document.getElementById('blacklistEditorModal').classList.add('active');
            window.currentBlacklistingIp = ip;
        };

        // Close blacklist modal
        window.closeBlacklistModal = function() {
            const modal = document.getElementById('blacklistEditorModal');
            if (modal) {
                modal.classList.remove('active');
            }
            window.currentBlacklistingIp = null;
        };

        // Save blacklist
        window.saveBlacklist = async function() {
            const ipInput = document.getElementById('blacklistIpInput');
            const reasonInput = document.getElementById('blacklistReasonInput');
            const notesInput = document.getElementById('blacklistNotesInput');
            const errorDiv = document.getElementById('blacklistError');

            if (!ipInput || !reasonInput || !notesInput || !errorDiv) {
                alert('Error: Blacklist form elements not found. Please refresh the page.');
                return;
            }

            const ip = ipInput.value.trim();
            const reason = reasonInput.value;
            const notes = notesInput.value.trim();

            if (!ip) {
                errorDiv.textContent = 'IP address is required';
                errorDiv.style.display = 'block';
                return;
            }

            if (!reason) {
                errorDiv.textContent = 'Reason is required';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const ipKey = ip.replace(/\./g, '_');
                const blacklistData = {
                    ip: ip,
                    timestamp: Date.now(),
                    date: new Date().toISOString(),
                    reason: reason,
                    notes: notes || null,
                    blacklistedBy: 'admin'
                };

                await database.ref(`blacklist/${ipKey}`).set(blacklistData);
                alert('‚úÖ User blacklisted successfully!');
                window.closeBlacklistModal();
                loadUsers();
                if (document.getElementById('tabBlacklisted').style.display !== 'none') {
                    loadBlacklistedUsers();
                }
            } catch (error) {
                console.error('Error blacklisting user:', error);
                errorDiv.textContent = 'Failed to blacklist: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        // Unblacklist user
        window.unblacklistUser = async function(ip) {
            if (!confirm(`Are you sure you want to unblacklist IP: ${ip}?`)) return;

            try {
                const ipKey = ip.replace(/\./g, '_');
                await database.ref(`blacklist/${ipKey}`).remove();
                alert('‚úÖ User unblacklisted successfully!');
                loadUsers();
                if (document.getElementById('tabBlacklisted').style.display !== 'none') {
                    loadBlacklistedUsers();
                }
            } catch (error) {
                console.error('Error unblacklisting user:', error);
                alert('‚ùå Failed to unblacklist user: ' + error.message);
            }
        }

        // Load blacklisted users
        async function loadBlacklistedUsers() {
            const content = document.getElementById('blacklistedContent');
            try {
                const snapshot = await database.ref('blacklist').once('value');
                if (!snapshot.exists()) {
                    content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üö´</div><div class="empty-state-text">No blacklisted users</div></div>';
                    return;
                }

                const blacklist = snapshot.val();
                const entries = Object.entries(blacklist);

                if (entries.length === 0) {
                    content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üö´</div><div class="empty-state-text">No blacklisted users</div></div>';
                    return;
                }

                let html = `
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>IP Address</th>
                                <th>Reason</th>
                                <th>Blacklisted Date</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                entries.forEach(([id, entry]) => {
                    const date = new Date(entry.timestamp || 0).toLocaleString();
                    html += `
                        <tr>
                            <td>${escapeHtml(entry.ip || id.replace(/_/g, '.'))}</td>
                            <td><span class="status-badge status-blacklisted">${escapeHtml(entry.reason || 'Unknown')}</span></td>
                            <td>${date}</td>
                            <td>${escapeHtml(entry.notes || 'No notes')}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action btn-view" onclick="viewBlacklistedUser('${escapeHtml(entry.ip || id.replace(/_/g, '.'))}')">View</button>
                                    <button class="btn-action btn-unblacklist" onclick="unblacklistUser('${escapeHtml(entry.ip || id.replace(/_/g, '.'))}')">Unblacklist</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                content.innerHTML = html;
            } catch (error) {
                console.error('Error loading blacklisted users:', error);
                content.innerHTML = '<div class="empty-state"><div class="empty-state-text">Error loading blacklisted users</div></div>';
            }
        }

        // View blacklisted user details
        async function viewBlacklistedUser(ip) {
            try {
                const ipKey = ip.replace(/\./g, '_');
                const snapshot = await database.ref(`blacklist/${ipKey}`).once('value');
                if (!snapshot.exists()) {
                    alert('Blacklist entry not found');
                    return;
                }

                const entry = snapshot.val();
                const visitsSnapshot = await database.ref('visits').once('value');
                const visits = visitsSnapshot.exists() ? visitsSnapshot.val() : {};
                const userVisits = Object.values(visits).filter(v => v.ip === ip);

                let html = `
                    <div class="info-row">
                        <span class="info-label">IP Address:</span>
                        <span class="info-value">${escapeHtml(ip)}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status:</span>
                        <span class="info-value">
                            <span class="status-badge status-blacklisted">Blacklisted</span>
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Reason:</span>
                        <span class="info-value">${escapeHtml(entry.reason || 'Unknown')}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Blacklisted Date:</span>
                        <span class="info-value">${new Date(entry.timestamp || 0).toLocaleString()}</span>
                    </div>
                    ${entry.notes ? `
                    <div class="info-row">
                        <span class="info-label">Notes:</span>
                        <span class="info-value">${escapeHtml(entry.notes)}</span>
                    </div>
                    ` : ''}
                    <div class="info-row">
                        <span class="info-label">Total Visits Before Blacklist:</span>
                        <span class="info-value">${userVisits.length}</span>
                    </div>
                    ${userVisits.length > 0 ? `
                    <div class="info-row">
                        <span class="info-label">Last Visit:</span>
                        <span class="info-value">${new Date(userVisits[userVisits.length - 1]?.timestamp || 0).toLocaleString()}</span>
                    </div>
                    ` : ''}
                `;

                document.getElementById('userInfoContent').innerHTML = html;
                document.getElementById('userInfoModal').classList.add('active');
            } catch (error) {
                console.error('Error viewing blacklisted user:', error);
                alert('Error loading user information');
            }
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Logout
        function logout() {
            sessionStorage.removeItem(ADMIN_SESSION_KEY);
            window.location.href = '/';
        }

        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load announcements
        async function loadAnnouncements() {
            const content = document.getElementById('announcementsContent');
            try {
                const snapshot = await database.ref('announcements').once('value');
                if (!snapshot.exists()) {
                    content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¢</div><div class="empty-state-text">No announcements yet</div></div>';
                    return;
                }

                const announcements = snapshot.val();
                const entries = Object.entries(announcements);

                if (entries.length === 0) {
                    content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¢</div><div class="empty-state-text">No announcements yet</div></div>';
                    return;
                }

                let html = `
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Priority</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                entries.forEach(([id, announcement]) => {
                    html += `
                        <tr>
                            <td>${escapeHtml(announcement.title || 'Untitled')}</td>
                            <td><span class="status-badge status-active">${announcement.type || 'info'}</span></td>
                            <td><span class="status-badge status-active">${announcement.priority || 'medium'}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action btn-view" onclick="editAnnouncement('${id}')">Edit</button>
                                    <button class="btn-action btn-delete" onclick="deleteAnnouncement('${id}')">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                content.innerHTML = html;
            } catch (error) {
                console.error('Error loading announcements:', error);
                content.innerHTML = '<div class="empty-state"><div class="empty-state-text">Error loading announcements</div></div>';
            }
        }

        // Load changelog
        async function loadChangelog() {
            const content = document.getElementById('changelogContent');
            try {
                const snapshot = await database.ref('changelog').once('value');
                if (!snapshot.exists()) {
                    content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><div class="empty-state-text">No changelog entries yet</div></div>';
                    return;
                }

                const changelog = snapshot.val();
                const entries = Object.entries(changelog);

                if (entries.length === 0) {
                    content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><div class="empty-state-text">No changelog entries yet</div></div>';
                    return;
                }

                let html = `
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Version</th>
                                <th>Date</th>
                                <th>Changes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                entries.forEach(([id, entry]) => {
                    html += `
                        <tr>
                            <td>${escapeHtml(entry.version || 'Unknown')}</td>
                            <td>${escapeHtml(entry.date || '')}</td>
                            <td>${(entry.changes || []).length} changes</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action btn-view" onclick="editChangelog('${id}')">Edit</button>
                                    <button class="btn-action btn-delete" onclick="deleteChangelog('${id}')">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                content.innerHTML = html;
            } catch (error) {
                console.error('Error loading changelog:', error);
                content.innerHTML = '<div class="empty-state"><div class="empty-state-text">Error loading changelog</div></div>';
            }
        }

        // Announcement editor functions
        let changelogChanges = [];
        window.currentEditingAnnouncementId = null;
        window.currentEditingChangelogId = null;

        window.editAnnouncement = async function(id) {
            const modal = document.getElementById('announcementEditorModal');
            const title = document.getElementById('announcementEditorTitle');
            const titleInput = document.getElementById('announcementTitleInput');
            const messageInput = document.getElementById('announcementMessageInput');
            const typeInput = document.getElementById('announcementTypeInput');
            const priorityInput = document.getElementById('announcementPriorityInput');
            const endDateInput = document.getElementById('announcementEndDateInput');
            const dismissibleInput = document.getElementById('announcementDismissibleInput');
            const linkInput = document.getElementById('announcementLinkInput');
            const linkTextInput = document.getElementById('announcementLinkTextInput');
            const errorDiv = document.getElementById('announcementEditorError');

            if (!modal) return;

            // Clear form
            titleInput.value = '';
            messageInput.value = '';
            typeInput.value = 'info';
            priorityInput.value = 'medium';
            endDateInput.value = '';
            dismissibleInput.checked = true;
            linkInput.value = '';
            linkTextInput.value = '';
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';

            if (id) {
                title.textContent = 'Edit Announcement';
                try {
                    const snapshot = await database.ref(`announcements/${id}`).once('value');
                    if (snapshot.exists()) {
                        const announcement = snapshot.val();
                        titleInput.value = announcement.title || '';
                        messageInput.value = announcement.message || '';
                        typeInput.value = announcement.type || 'info';
                        priorityInput.value = announcement.priority || 'medium';
                        if (announcement.endDate) {
                            const endDate = new Date(announcement.endDate);
                            endDateInput.value = endDate.toISOString().slice(0, 16);
                        }
                        dismissibleInput.checked = announcement.dismissible !== false;
                        linkInput.value = announcement.link || '';
                        linkTextInput.value = announcement.linkText || '';
                    }
                } catch (error) {
                    console.error('Error loading announcement:', error);
                    errorDiv.textContent = 'Failed to load announcement';
                    errorDiv.style.display = 'block';
                }
            } else {
                title.textContent = 'Add Announcement';
            }

            modal.classList.add('active');
            window.currentEditingAnnouncementId = id;
        };

        window.hideAnnouncementEditor = function() {
            const modal = document.getElementById('announcementEditorModal');
            if (modal) {
                modal.classList.remove('active');
            }
            window.currentEditingAnnouncementId = null;
        };

        window.saveAnnouncement = async function() {
            const titleInput = document.getElementById('announcementTitleInput');
            const messageInput = document.getElementById('announcementMessageInput');
            const typeInput = document.getElementById('announcementTypeInput');
            const priorityInput = document.getElementById('announcementPriorityInput');
            const endDateInput = document.getElementById('announcementEndDateInput');
            const dismissibleInput = document.getElementById('announcementDismissibleInput');
            const linkInput = document.getElementById('announcementLinkInput');
            const linkTextInput = document.getElementById('announcementLinkTextInput');
            const errorDiv = document.getElementById('announcementEditorError');

            if (!titleInput.value.trim()) {
                errorDiv.textContent = 'Title is required';
                errorDiv.style.display = 'block';
                return;
            }
            if (!messageInput.value.trim()) {
                errorDiv.textContent = 'Message is required';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const announcementData = {
                    title: titleInput.value.trim(),
                    message: messageInput.value.trim(),
                    type: typeInput.value,
                    priority: priorityInput.value,
                    dismissible: dismissibleInput.checked
                };

                if (endDateInput.value) {
                    announcementData.endDate = new Date(endDateInput.value).getTime();
                }
                if (linkInput.value.trim()) {
                    announcementData.link = linkInput.value.trim();
                    announcementData.linkText = linkTextInput.value.trim() || 'Learn More';
                }

                const id = window.currentEditingAnnouncementId || 'announcement_' + Date.now();
                await database.ref(`announcements/${id}`).set(announcementData);
                
                alert('‚úÖ Announcement saved!');
                hideAnnouncementEditor();
                loadAnnouncements();
            } catch (error) {
                console.error('Error saving announcement:', error);
                errorDiv.textContent = 'Failed to save: ' + error.message;
                errorDiv.style.display = 'block';
            }
        };

        window.deleteAnnouncement = async function(id) {
            if (!confirm('Are you sure you want to delete this announcement?')) return;
            try {
                await database.ref(`announcements/${id}`).remove();
                alert('‚úÖ Announcement deleted!');
                loadAnnouncements();
            } catch (error) {
                console.error('Error deleting announcement:', error);
                alert('‚ùå Failed to delete: ' + error.message);
            }
        };

        // Changelog editor functions
        window.editChangelog = async function(id) {
            const modal = document.getElementById('changelogEditorModal');
            const title = document.getElementById('changelogEditorTitle');
            const versionInput = document.getElementById('changelogVersionInput');
            const dateInput = document.getElementById('changelogDateInput');
            const typeInput = document.getElementById('changelogTypeInput');
            const downloadUrlInput = document.getElementById('changelogDownloadUrlInput');
            const changesList = document.getElementById('changelogChangesList');
            const errorDiv = document.getElementById('changelogEditorError');

            if (!modal) return;

            changelogChanges = [];
            versionInput.value = '';
            dateInput.value = '';
            typeInput.value = '';
            downloadUrlInput.value = '';
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
            renderChangelogChanges();

            if (id) {
                title.textContent = 'Edit Changelog Entry';
                try {
                    const snapshot = await database.ref(`changelog/${id}`).once('value');
                    if (snapshot.exists()) {
                        const entry = snapshot.val();
                        versionInput.value = entry.version || '';
                        if (entry.date) {
                            const dateObj = new Date(entry.date);
                            if (!isNaN(dateObj.getTime())) {
                                dateInput.value = dateObj.toISOString().split('T')[0];
                            }
                        }
                        typeInput.value = entry.type || '';
                        downloadUrlInput.value = entry.downloadUrl || '';
                        changelogChanges = Array.isArray(entry.changes) ? [...entry.changes] : [];
                        renderChangelogChanges();
                    }
                } catch (error) {
                    console.error('Error loading changelog:', error);
                    errorDiv.textContent = 'Failed to load changelog entry';
                    errorDiv.style.display = 'block';
                }
            } else {
                title.textContent = 'Add Changelog Entry';
                const today = new Date();
                dateInput.value = today.toISOString().split('T')[0];
            }

            modal.classList.add('active');
            window.currentEditingChangelogId = id;
        };

        window.hideChangelogEditor = function() {
            const modal = document.getElementById('changelogEditorModal');
            if (modal) {
                modal.classList.remove('active');
            }
            window.currentEditingChangelogId = null;
            changelogChanges = [];
        };

        function renderChangelogChanges() {
            const changesList = document.getElementById('changelogChangesList');
            if (!changesList) return;

            if (changelogChanges.length === 0) {
                changesList.innerHTML = '<div style="color: #888; font-size: 13px; padding: 8px;">No changes added yet</div>';
                return;
            }

            changesList.innerHTML = changelogChanges.map((change, index) => `
                <div class="changelog-change-item">
                    <span class="changelog-change-item-text">${escapeHtml(change)}</span>
                    <button type="button" class="changelog-change-item-remove" onclick="removeChangelogChange(${index})">Remove</button>
                </div>
            `).join('');
        }

        window.addChangelogChange = function() {
            const changeInput = document.getElementById('changelogChangeInput');
            if (!changeInput) return;
            const change = changeInput.value.trim();
            if (!change) return;
            changelogChanges.push(change);
            changeInput.value = '';
            renderChangelogChanges();
        };

        window.removeChangelogChange = function(index) {
            changelogChanges.splice(index, 1);
            renderChangelogChanges();
        };

        window.saveChangelog = async function() {
            const versionInput = document.getElementById('changelogVersionInput');
            const dateInput = document.getElementById('changelogDateInput');
            const typeInput = document.getElementById('changelogTypeInput');
            const downloadUrlInput = document.getElementById('changelogDownloadUrlInput');
            const errorDiv = document.getElementById('changelogEditorError');

            if (!versionInput.value.trim()) {
                errorDiv.textContent = 'Version is required';
                errorDiv.style.display = 'block';
                return;
            }
            if (!dateInput.value) {
                errorDiv.textContent = 'Release date is required';
                errorDiv.style.display = 'block';
                return;
            }
            if (changelogChanges.length === 0) {
                errorDiv.textContent = 'At least one change is required';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const dateObj = new Date(dateInput.value);
                const date = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                
                const changelogData = {
                    version: versionInput.value.trim(),
                    date: date,
                    changes: changelogChanges.filter(c => c.trim().length > 0)
                };

                if (typeInput.value.trim()) {
                    changelogData.type = typeInput.value.trim();
                }
                if (downloadUrlInput.value.trim()) {
                    changelogData.downloadUrl = downloadUrlInput.value.trim();
                }

                const id = window.currentEditingChangelogId || 'v' + versionInput.value.replace(/\./g, '_') + '_' + Date.now();
                await database.ref(`changelog/${id}`).set(changelogData);

                alert('‚úÖ Changelog saved!');
                hideChangelogEditor();
                loadChangelog();
            } catch (error) {
                console.error('Error saving changelog:', error);
                errorDiv.textContent = 'Failed to save: ' + error.message;
                errorDiv.style.display = 'block';
            }
        };

        window.deleteChangelog = async function(id) {
            if (!confirm('Are you sure you want to delete this changelog entry?')) return;
            try {
                await database.ref(`changelog/${id}`).remove();
                alert('‚úÖ Changelog deleted!');
                loadChangelog();
            } catch (error) {
                console.error('Error deleting changelog:', error);
                alert('‚ùå Failed to delete: ' + error.message);
            }
        };

        // Tab switching
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                
                // Update tab buttons
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update content
                document.querySelectorAll('.admin-content-card').forEach(c => c.style.display = 'none');
                document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).style.display = 'block';
                
                // Load data for active tab
                if (tabName === 'announcements') {
                    loadAnnouncements();
                } else if (tabName === 'changelog') {
                    loadChangelog();
                } else if (tabName === 'reviews') {
                    loadReviews();
                } else if (tabName === 'users') {
                    loadUsers();
                } else if (tabName === 'maintenance') {
                    loadMaintenanceSettings();
                } else if (tabName === 'backup') {
                    loadBackupTools();
                } else if (tabName === 'surveys') {
                    loadSurveys();
                } else if (tabName === 'webhooks') {
                    loadWebhooks();
                } else if (tabName === 'tickets') {
                    loadTickets();
                }
            });
        });

        // ============================================
        // MAINTENANCE MODE
        // ============================================
        async function loadMaintenanceSettings() {
            const content = document.getElementById('maintenanceContent');
            try {
                const snapshot = await database.ref('maintenance').once('value');
                const maintenance = snapshot.exists() ? snapshot.val() : { enabled: false, message: '', returnTime: null };

                let html = `
                    <div style="background: ${maintenance.enabled ? 'rgba(239, 68, 68, 0.1)' : 'rgba(34, 197, 94, 0.1)'}; border: 1px solid ${maintenance.enabled ? 'rgba(239, 68, 68, 0.3)' : 'rgba(34, 197, 94, 0.3)'}; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                            <div>
                                <h3 style="color: #e5e5e5; margin-bottom: 5px;">Status: <span style="color: ${maintenance.enabled ? '#ef4444' : '#22c55e'}">${maintenance.enabled ? 'ENABLED' : 'DISABLED'}</span></h3>
                                ${maintenance.enabled ? '<p style="color: #888; font-size: 13px;">Site is currently in maintenance mode</p>' : '<p style="color: #888; font-size: 13px;">Site is accessible to all users</p>'}
                            </div>
                            <button class="admin-btn ${maintenance.enabled ? 'admin-btn-danger' : 'admin-btn-primary'}" onclick="openMaintenanceModal()">
                                ${maintenance.enabled ? '‚öôÔ∏è Configure' : 'üîß Enable Maintenance'}
                            </button>
                        </div>
                        ${maintenance.enabled ? `
                            <div style="background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 15px; margin-top: 15px;">
                                <p style="color: #e5e5e5; margin-bottom: 10px;"><strong>Message:</strong></p>
                                <p style="color: #888; margin-bottom: 10px;">${escapeHtml(maintenance.message || 'No message set')}</p>
                                ${maintenance.returnTime ? `<p style="color: #888; font-size: 12px;">Estimated return: ${new Date(maintenance.returnTime).toLocaleString()}</p>` : ''}
                            </div>
                        ` : ''}
                    </div>
                    <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 20px;">
                        <h4 style="color: #e5e5e5; margin-bottom: 10px;">‚ÑπÔ∏è About Maintenance Mode</h4>
                        <ul style="color: #888; font-size: 14px; line-height: 1.8; padding-left: 20px;">
                            <li>When enabled, all users (except admins) will see a maintenance page</li>
                            <li>You can customize the message shown to users</li>
                            <li>Set an estimated return time to inform users when the site will be back</li>
                            <li>Admin panel remains accessible during maintenance</li>
                        </ul>
                    </div>
                `;

                content.innerHTML = html;
            } catch (error) {
                console.error('Error loading maintenance settings:', error);
                content.innerHTML = '<div class="empty-state"><div class="empty-state-text">Error loading maintenance settings</div></div>';
            }
        }

        window.openMaintenanceModal = function() {
            database.ref('maintenance').once('value').then(snapshot => {
                const maintenance = snapshot.exists() ? snapshot.val() : { enabled: false, message: '', returnTime: null };
                const enabledCheckbox = document.getElementById('maintenanceEnabled');
                const messageInput = document.getElementById('maintenanceMessage');
                const returnTimeInput = document.getElementById('maintenanceReturnTime');
                const modal = document.getElementById('maintenanceModal');
                
                if (!enabledCheckbox || !messageInput || !returnTimeInput || !modal) {
                    console.error('Maintenance modal elements not found');
                    alert('Error: Maintenance modal not found. Please refresh the page.');
                    return;
                }
                
                enabledCheckbox.checked = maintenance.enabled || false;
                messageInput.value = maintenance.message || 'We\'re currently performing scheduled maintenance. We\'ll be back shortly!';
                if (maintenance.returnTime) {
                    const returnDate = new Date(maintenance.returnTime);
                    returnTimeInput.value = returnDate.toISOString().slice(0, 16);
                } else {
                    returnTimeInput.value = '';
                }
                modal.classList.add('active');
            }).catch(error => {
                console.error('Error loading maintenance settings:', error);
                alert('Error loading maintenance settings: ' + error.message);
            });
        }

        window.closeMaintenanceModal = function() {
            const modal = document.getElementById('maintenanceModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function toggleMaintenancePreview() {
            // Could add preview functionality here
        }

        window.saveMaintenanceSettings = async function() {
            const enabledCheckbox = document.getElementById('maintenanceEnabled');
            const messageInput = document.getElementById('maintenanceMessage');
            const returnTimeInput = document.getElementById('maintenanceReturnTime');
            const errorDiv = document.getElementById('maintenanceError');

            if (!enabledCheckbox || !messageInput || !returnTimeInput || !errorDiv) {
                alert('Error: Maintenance form elements not found. Please refresh the page.');
                return;
            }

            const enabled = enabledCheckbox.checked;
            const message = messageInput.value.trim();

            if (enabled && !message) {
                errorDiv.textContent = 'Message is required when maintenance mode is enabled';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const maintenanceData = {
                    enabled: enabled,
                    message: message,
                    updatedAt: Date.now(),
                    updatedBy: 'admin'
                };

                if (returnTimeInput.value) {
                    maintenanceData.returnTime = new Date(returnTimeInput.value).getTime();
                } else {
                    maintenanceData.returnTime = null;
                }

                await database.ref('maintenance').set(maintenanceData);
                alert('‚úÖ Maintenance settings saved!');
                closeMaintenanceModal();
                loadMaintenanceSettings();
            } catch (error) {
                console.error('Error saving maintenance settings:', error);
                errorDiv.textContent = 'Failed to save: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        // ============================================
        // BACKUP & RESTORE
        // ============================================
        async function loadBackupTools() {
            const content = document.getElementById('backupContent');
            
            // Load backup history
            let backupHistory = [];
            try {
                const snapshot = await database.ref('backups').once('value');
                if (snapshot.exists()) {
                    backupHistory = Object.entries(snapshot.val())
                        .map(([id, backup]) => ({ id, ...backup }))
                        .sort((a, b) => b.timestamp - a.timestamp)
                        .slice(0, 10); // Show last 10 backups
                }
            } catch (error) {
                console.error('Error loading backup history:', error);
            }

            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 12px; padding: 24px;">
                        <div style="font-size: 32px; margin-bottom: 12px;">üíæ</div>
                        <h3 style="color: #e5e5e5; margin-bottom: 8px;">Create Backup</h3>
                        <p style="color: #888; font-size: 13px; margin-bottom: 16px;">Export all database data to a JSON file</p>
                        <button class="admin-btn admin-btn-primary" onclick="createBackup()" style="width: 100%;">Create Backup Now</button>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 12px; padding: 24px;">
                        <div style="font-size: 32px; margin-bottom: 12px;">üì§</div>
                        <h3 style="color: #e5e5e5; margin-bottom: 8px;">Restore Backup</h3>
                        <p style="color: #888; font-size: 13px; margin-bottom: 16px;">Import data from a JSON backup file</p>
                        <button class="admin-btn" onclick="restoreBackup()" style="width: 100%; background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.3); color: #22c55e;">Restore from File</button>
                    </div>
                </div>

                <div style="background: rgba(26, 26, 26, 0.5); border: 1px solid rgba(74, 74, 74, 0.5); border-radius: 12px; padding: 20px;">
                    <h3 style="color: #e5e5e5; margin-bottom: 15px;">Backup History</h3>
            `;

            if (backupHistory.length === 0) {
                html += '<div class="empty-state"><div class="empty-state-text">No backups created yet</div></div>';
            } else {
                html += `
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Size</th>
                                <th>Items</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                backupHistory.forEach(backup => {
                    const date = new Date(backup.timestamp);
                    html += `
                        <tr>
                            <td>${date.toLocaleString()}</td>
                            <td>${formatBytes(backup.size || 0)}</td>
                            <td>${backup.itemCount || 0} items</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action btn-view" onclick="downloadBackup('${backup.id}')">Download</button>
                                    <button class="btn-action btn-delete" onclick="deleteBackup('${backup.id}')">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
            }

            html += '</div>';

            content.innerHTML = html;
        }

        async function createBackup() {
            if (!confirm('Create a backup of all database data? This may take a moment.')) return;

            try {
                const data = {
                    announcements: {},
                    changelog: {},
                    downloads: {},
                    ratings: {},
                    translations: {},
                    visits: {},
                    blacklist: {},
                    maintenance: {}
                };

                // Try to read each path individually to handle permission errors gracefully
                const paths = [
                    { key: 'announcements', ref: database.ref('announcements') },
                    { key: 'changelog', ref: database.ref('changelog') },
                    { key: 'downloads', ref: database.ref('downloads') },
                    { key: 'ratings', ref: database.ref('ratings') },
                    { key: 'translations', ref: database.ref('translations') },
                    { key: 'visits', ref: database.ref('visits') },
                    { key: 'blacklist', ref: database.ref('blacklist') },
                    { key: 'maintenance', ref: database.ref('maintenance') }
                ];

                for (const path of paths) {
                    try {
                        const snapshot = await path.ref.once('value');
                        if (snapshot.exists()) {
                            data[path.key] = snapshot.val();
                        }
                    } catch (error) {
                        console.warn(`Warning: Could not backup ${path.key}:`, error.message);
                        // Continue with other paths even if one fails
                    }
                }

                const jsonData = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                a.download = `recon-backup-${timestamp}.json`;
                a.click();
                URL.revokeObjectURL(url);

                // Save backup record
                const backupId = 'backup_' + Date.now();
                const itemCount = Object.values(data).reduce((sum, section) => sum + Object.keys(section).length, 0);
                await database.ref(`backups/${backupId}`).set({
                    timestamp: Date.now(),
                    size: blob.size,
                    itemCount: itemCount,
                    createdBy: 'admin'
                });

                alert('‚úÖ Backup created and downloaded successfully!');
                loadBackupTools();
            } catch (error) {
                console.error('Backup error:', error);
                alert('‚ùå Failed to create backup: ' + error.message);
            }
        }

        async function restoreBackup() {
            if (!confirm('‚ö†Ô∏è WARNING: This will overwrite all existing data. Are you sure you want to continue?')) return;
            if (!confirm('‚ö†Ô∏è This action cannot be undone. Continue?')) return;

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const data = JSON.parse(text);

                    // Validate backup structure
                    if (!data || typeof data !== 'object') {
                        throw new Error('Invalid backup file format');
                    }

                    // Show progress
                    const progress = confirm('Restoring backup... This may take a moment. Click OK to continue.');
                    if (!progress) return;

                    // Restore data
                    if (data.announcements) await database.ref('announcements').set(data.announcements);
                    if (data.changelog) await database.ref('changelog').set(data.changelog);
                    if (data.downloads) await database.ref('downloads').set(data.downloads);
                    if (data.ratings) await database.ref('ratings').set(data.ratings);
                    if (data.translations) await database.ref('translations').set(data.translations);
                    if (data.visits) await database.ref('visits').set(data.visits);
                    if (data.blacklist) await database.ref('blacklist').set(data.blacklist);
                    if (data.maintenance) await database.ref('maintenance').set(data.maintenance);

                    alert('‚úÖ Backup restored successfully! The page will reload.');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } catch (error) {
                    console.error('Restore error:', error);
                    alert('‚ùå Failed to restore backup: ' + error.message);
                }
            };
            input.click();
        }

        async function downloadBackup(backupId) {
            // This would download a specific backup from storage
            // For now, just create a new backup
            alert('Downloading backup...');
            createBackup();
        }

        async function deleteBackup(backupId) {
            if (!confirm('Delete this backup record?')) return;
            try {
                await database.ref(`backups/${backupId}`).remove();
                alert('‚úÖ Backup record deleted!');
                loadBackupTools();
            } catch (error) {
                console.error('Error deleting backup:', error);
                alert('‚ùå Failed to delete: ' + error.message);
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            trackUserVisit();
            loadAnnouncements();
            
            // Close modals on outside click
            document.getElementById('announcementEditorModal').addEventListener('click', (e) => {
                if (e.target.id === 'announcementEditorModal') {
                    hideAnnouncementEditor();
                }
            });
            
            document.getElementById('changelogEditorModal').addEventListener('click', (e) => {
                if (e.target.id === 'changelogEditorModal') {
                    hideChangelogEditor();
                }
            });
            
            document.getElementById('maintenanceModal')?.addEventListener('click', (e) => {
                if (e.target.id === 'maintenanceModal') {
                    closeMaintenanceModal();
                }
            });
            
            document.getElementById('blacklistEditorModal')?.addEventListener('click', (e) => {
                if (e.target.id === 'blacklistEditorModal') {
                    closeBlacklistModal();
                }
            });
            
            // Enter key for changelog changes
            document.getElementById('changelogChangeInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addChangelogChange();
                }
            });
        });

        // Close modal on outside click
        document.getElementById('userInfoModal').addEventListener('click', (e) => {
            if (e.target.id === 'userInfoModal') {
                closeModal('userInfoModal');
            }
        });

        // ============================================
        // SURVEYS & POLLS FUNCTIONS
        // ============================================
        let surveyOptions = [];

        async function loadSurveys() {
            const content = document.getElementById('surveysContent');
            try {
                const snapshot = await database.ref('surveys').once('value');
                if (!snapshot.exists()) {
                    content.innerHTML = '<div class="empty-state"><div class="empty-state-text">No surveys created yet</div></div>';
                    return;
                }

                const surveys = snapshot.val();
                const entries = Object.entries(surveys);

                if (entries.length === 0) {
                    content.innerHTML = '<div class="empty-state"><div class="empty-state-text">No surveys created yet</div></div>';
                    return;
                }

                let html = `
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Options</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                entries.forEach(([id, survey]) => {
                    html += `
                        <tr>
                            <td>${escapeHtml(survey.title || 'Untitled')}</td>
                            <td><span class="status-badge ${survey.type === 'poll' ? 'status-active' : survey.type === 'survey' ? 'status-warning' : 'status-info'}">${survey.type || 'poll'}</span></td>
                            <td>${survey.options ? survey.options.length : 0} options</td>
                            <td><span class="status-badge ${survey.active ? 'status-active' : 'status-inactive'}">${survey.active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action btn-view" onclick="editSurvey('${id}')">Edit</button>
                                    <button class="btn-action btn-delete" onclick="deleteSurvey('${id}')">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                content.innerHTML = html;
            } catch (error) {
                console.error('Error loading surveys:', error);
                content.innerHTML = '<div class="empty-state"><div class="empty-state-text">Error loading surveys</div></div>';
            }
        }

        window.editSurvey = async function(id) {
            const modal = document.getElementById('surveyEditorModal');
            const title = document.getElementById('surveyEditorTitle');
            const titleInput = document.getElementById('surveyTitleInput');
            const descriptionInput = document.getElementById('surveyDescriptionInput');
            const typeInput = document.getElementById('surveyTypeInput');
            const activeInput = document.getElementById('surveyActiveInput');
            const errorDiv = document.getElementById('surveyEditorError');

            if (!modal) return;

            surveyOptions = [];
            titleInput.value = '';
            descriptionInput.value = '';
            typeInput.value = 'poll';
            activeInput.checked = true;
            errorDiv.style.display = 'none';
            renderSurveyOptions();

            if (id) {
                title.textContent = 'Edit Survey/Poll';
                try {
                    const snapshot = await database.ref(`surveys/${id}`).once('value');
                    if (snapshot.exists()) {
                        const survey = snapshot.val();
                        titleInput.value = survey.title || '';
                        descriptionInput.value = survey.description || '';
                        typeInput.value = survey.type || 'poll';
                        activeInput.checked = survey.active !== false;
                        surveyOptions = survey.options || [];
                        renderSurveyOptions();
                    }
                } catch (error) {
                    console.error('Error loading survey:', error);
                    alert('Error loading survey: ' + error.message);
                }
            } else {
                title.textContent = 'Create Survey/Poll';
            }

            modal.classList.add('active');
            window.currentEditingSurveyId = id || null;
        };

        window.hideSurveyEditor = function() {
            const modal = document.getElementById('surveyEditorModal');
            if (modal) {
                modal.classList.remove('active');
            }
            window.currentEditingSurveyId = null;
        };

        window.addSurveyOption = function() {
            const input = document.getElementById('surveyOptionInput');
            const option = input.value.trim();
            if (option && !surveyOptions.includes(option)) {
                surveyOptions.push(option);
                input.value = '';
                renderSurveyOptions();
            }
        };

        function removeSurveyOption(index) {
            surveyOptions.splice(index, 1);
            renderSurveyOptions();
        }

        function renderSurveyOptions() {
            const list = document.getElementById('surveyOptionsList');
            if (!list) return;

            if (surveyOptions.length === 0) {
                list.innerHTML = '<div style="color: #888; font-size: 13px; padding: 12px; background: rgba(26, 26, 26, 0.5); border-radius: 4px;">No options added yet</div>';
                return;
            }

            list.innerHTML = surveyOptions.map((option, index) => `
                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: rgba(26, 26, 26, 0.5); border-radius: 4px; margin-bottom: 8px;">
                    <span style="flex: 1; color: #e5e5e5;">${escapeHtml(option)}</span>
                    <button type="button" class="btn-action btn-delete" onclick="removeSurveyOption(${index})" style="padding: 4px 8px;">Remove</button>
                </div>
            `).join('');
        }

        window.saveSurvey = async function() {
            const titleInput = document.getElementById('surveyTitleInput');
            const descriptionInput = document.getElementById('surveyDescriptionInput');
            const typeInput = document.getElementById('surveyTypeInput');
            const activeInput = document.getElementById('surveyActiveInput');
            const errorDiv = document.getElementById('surveyEditorError');

            const title = titleInput.value.trim();
            const description = descriptionInput.value.trim();
            const type = typeInput.value;
            const active = activeInput.checked;

            if (!title) {
                errorDiv.textContent = 'Title is required';
                errorDiv.style.display = 'block';
                return;
            }

            if (surveyOptions.length < 2) {
                errorDiv.textContent = 'At least 2 options are required';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const surveyData = {
                    title,
                    description: description || null,
                    type,
                    options: surveyOptions,
                    active,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };

                const id = window.currentEditingSurveyId || 'survey_' + Date.now();
                await database.ref(`surveys/${id}`).set(surveyData);
                alert('‚úÖ Survey saved successfully!');
                hideSurveyEditor();
                loadSurveys();
            } catch (error) {
                console.error('Error saving survey:', error);
                errorDiv.textContent = 'Failed to save: ' + error.message;
                errorDiv.style.display = 'block';
            }
        };

        window.deleteSurvey = async function(id) {
            if (!confirm('Are you sure you want to delete this survey?')) return;
            try {
                await database.ref(`surveys/${id}`).remove();
                alert('‚úÖ Survey deleted!');
                loadSurveys();
            } catch (error) {
                console.error('Error deleting survey:', error);
                alert('‚ùå Failed to delete: ' + error.message);
            }
        };

        // ============================================
        // DISCORD WEBHOOK FUNCTIONS
        // ============================================
        let embedFields = [];

        async function loadWebhooks() {
            const content = document.getElementById('webhooksContent');
            try {
                const snapshot = await database.ref('webhooks').once('value');
                if (!snapshot.exists()) {
                    content.innerHTML = '<div class="empty-state"><div class="empty-state-text">No webhooks created yet</div></div>';
                    return;
                }

                const webhooks = snapshot.val();
                const entries = Object.entries(webhooks);

                if (entries.length === 0) {
                    content.innerHTML = '<div class="empty-state"><div class="empty-state-text">No webhooks created yet</div></div>';
                    return;
                }

                let html = `
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>URL</th>
                                <th>Last Sent</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                entries.forEach(([id, webhook]) => {
                    const lastSent = webhook.lastSent ? new Date(webhook.lastSent).toLocaleString() : 'Never';
                    html += `
                        <tr>
                            <td>${escapeHtml(webhook.name || 'Unnamed')}</td>
                            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(webhook.url || '')}</td>
                            <td>${lastSent}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action btn-view" onclick="editWebhook('${id}')">Edit</button>
                                    <button class="btn-action btn-view" onclick="testWebhookById('${id}')">Test</button>
                                    <button class="btn-action btn-delete" onclick="deleteWebhook('${id}')">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                content.innerHTML = html;
            } catch (error) {
                console.error('Error loading webhooks:', error);
                content.innerHTML = '<div class="empty-state"><div class="empty-state-text">Error loading webhooks</div></div>';
            }
        }

        window.createWebhook = function() {
            editWebhook(null);
        };

        window.editWebhook = async function(id) {
            const modal = document.getElementById('webhookEditorModal');
            const title = document.getElementById('webhookEditorTitle');
            const nameInput = document.getElementById('webhookNameInput');
            const urlInput = document.getElementById('webhookUrlInput');
            const errorDiv = document.getElementById('webhookEditorError');

            if (!modal) return;

            // Reset all fields
            nameInput.value = '';
            urlInput.value = '';
            document.getElementById('embedTitleInput').value = '';
            document.getElementById('embedDescriptionInput').value = '';
            document.getElementById('embedUrlInput').value = '';
            document.getElementById('embedColorInput').value = '#5865F2';
            document.getElementById('embedAuthorNameInput').value = '';
            document.getElementById('embedAuthorIconInput').value = '';
            document.getElementById('embedFooterInput').value = '';
            document.getElementById('embedFooterIconInput').value = '';
            document.getElementById('embedThumbnailInput').value = '';
            document.getElementById('embedImageInput').value = '';
            document.getElementById('embedTimestampInput').value = 'now';
            document.getElementById('embedTimestampCustomInput').style.display = 'none';
            embedFields = [];
            renderEmbedFields();
            errorDiv.style.display = 'none';
            updateEmbedPreview();

            if (id) {
                title.textContent = 'Edit Discord Webhook';
                try {
                    const snapshot = await database.ref(`webhooks/${id}`).once('value');
                    if (snapshot.exists()) {
                        const webhook = snapshot.val();
                        nameInput.value = webhook.name || '';
                        urlInput.value = webhook.url || '';
                        if (webhook.embed) {
                            document.getElementById('embedTitleInput').value = webhook.embed.title || '';
                            document.getElementById('embedDescriptionInput').value = webhook.embed.description || '';
                            document.getElementById('embedUrlInput').value = webhook.embed.url || '';
                            document.getElementById('embedColorInput').value = webhook.embed.color || '#5865F2';
                            document.getElementById('embedAuthorNameInput').value = webhook.embed.author?.name || '';
                            document.getElementById('embedAuthorIconInput').value = webhook.embed.author?.icon_url || '';
                            document.getElementById('embedFooterInput').value = webhook.embed.footer?.text || '';
                            document.getElementById('embedFooterIconInput').value = webhook.embed.footer?.icon_url || '';
                            document.getElementById('embedThumbnailInput').value = webhook.embed.thumbnail?.url || '';
                            document.getElementById('embedImageInput').value = webhook.embed.image?.url || '';
                            if (webhook.embed.timestamp) {
                                document.getElementById('embedTimestampInput').value = 'custom';
                                const date = new Date(webhook.embed.timestamp);
                                document.getElementById('embedTimestampCustomInput').value = date.toISOString().slice(0, 16);
                                document.getElementById('embedTimestampCustomInput').style.display = 'block';
                            } else {
                                document.getElementById('embedTimestampInput').value = 'now';
                            }
                            embedFields = webhook.embed.fields || [];
                            renderEmbedFields();
                        }
                        updateEmbedPreview();
                    }
                } catch (error) {
                    console.error('Error loading webhook:', error);
                    alert('Error loading webhook: ' + error.message);
                }
            } else {
                title.textContent = 'Create Discord Webhook';
            }

            modal.classList.add('active');
            window.currentEditingWebhookId = id || null;
        };

        window.hideWebhookEditor = function() {
            const modal = document.getElementById('webhookEditorModal');
            if (modal) {
                modal.classList.remove('active');
            }
            window.currentEditingWebhookId = null;
        };

        window.addEmbedField = function() {
            embedFields.push({ name: '', value: '', inline: false });
            renderEmbedFields();
        };

        function removeEmbedField(index) {
            embedFields.splice(index, 1);
            renderEmbedFields();
            updateEmbedPreview();
        }

        function renderEmbedFields() {
            const list = document.getElementById('embedFieldsList');
            if (!list) return;

            if (embedFields.length === 0) {
                list.innerHTML = '<div style="color: #888; font-size: 13px; padding: 12px; background: rgba(26, 26, 26, 0.5); border-radius: 4px;">No fields added yet</div>';
                return;
            }

            list.innerHTML = embedFields.map((field, index) => `
                <div style="background: rgba(26, 26, 26, 0.5); border-radius: 4px; padding: 12px; margin-bottom: 8px;">
                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                        <input type="text" class="form-input" placeholder="Field Name" value="${escapeHtml(field.name || '')}" onchange="embedFields[${index}].name = this.value; updateEmbedPreview();" style="flex: 1;" maxlength="256">
                        <label style="display: flex; align-items: center; gap: 4px; color: #888; font-size: 12px;">
                            <input type="checkbox" ${field.inline ? 'checked' : ''} onchange="embedFields[${index}].inline = this.checked; updateEmbedPreview();"> Inline
                        </label>
                        <button type="button" class="btn-action btn-delete" onclick="removeEmbedField(${index})" style="padding: 4px 8px;">Remove</button>
                    </div>
                    <textarea class="form-input" placeholder="Field Value" rows="2" onchange="embedFields[${index}].value = this.value; updateEmbedPreview();" maxlength="1024">${escapeHtml(field.value || '')}</textarea>
                </div>
            `).join('');
        }

        window.updateEmbedPreview = function() {
            const preview = document.getElementById('embedPreview');
            if (!preview) return;

            const embed = buildEmbedObject();
            preview.innerHTML = renderEmbedPreview(embed);
        };

        function buildEmbedObject() {
            const timestampValue = document.getElementById('embedTimestampInput').value;
            let timestamp = null;
            if (timestampValue === 'now') {
                timestamp = new Date().toISOString();
            } else if (timestampValue === 'custom') {
                const customDate = document.getElementById('embedTimestampCustomInput').value;
                if (customDate) {
                    timestamp = new Date(customDate).toISOString();
                }
            }

            const colorHex = document.getElementById('embedColorInput').value;
            const color = parseInt(colorHex.replace('#', ''), 16);

            const embed = {
                title: document.getElementById('embedTitleInput').value || null,
                description: document.getElementById('embedDescriptionInput').value || null,
                url: document.getElementById('embedUrlInput').value || null,
                color: color,
                timestamp: timestamp,
                author: null,
                footer: null,
                thumbnail: null,
                image: null,
                fields: embedFields.filter(f => f.name && f.value).length > 0 ? embedFields.filter(f => f.name && f.value) : null
            };

            const authorName = document.getElementById('embedAuthorNameInput').value;
            const authorIcon = document.getElementById('embedAuthorIconInput').value;
            if (authorName || authorIcon) {
                embed.author = {
                    name: authorName || null,
                    icon_url: authorIcon || null
                };
            }

            const footerText = document.getElementById('embedFooterInput').value;
            const footerIcon = document.getElementById('embedFooterIconInput').value;
            if (footerText || footerIcon) {
                embed.footer = {
                    text: footerText || null,
                    icon_url: footerIcon || null
                };
            }

            const thumbnail = document.getElementById('embedThumbnailInput').value;
            if (thumbnail) {
                embed.thumbnail = { url: thumbnail };
            }

            const image = document.getElementById('embedImageInput').value;
            if (image) {
                embed.image = { url: image };
            }

            // Remove null values
            Object.keys(embed).forEach(key => {
                if (embed[key] === null) delete embed[key];
            });

            return embed;
        }

        function renderEmbedPreview(embed) {
            if (!embed.title && !embed.description && !embed.fields && !embed.author && !embed.footer) {
                return '<div style="color: #dcddde; font-size: 14px;">Preview will appear here...</div>';
            }

            const colorHex = embed.color ? '#' + embed.color.toString(16).padStart(6, '0') : '#5865F2';
            let html = `<div style="border-left: 4px solid ${colorHex}; padding-left: 12px;">`;

            if (embed.author) {
                html += `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">`;
                if (embed.author.icon_url) {
                    html += `<img src="${escapeHtml(embed.author.icon_url)}" style="width: 20px; height: 20px; border-radius: 50%;" onerror="this.style.display='none';">`;
                }
                if (embed.author.name) {
                    html += `<span style="color: #fff; font-weight: 600; font-size: 14px;">${escapeHtml(embed.author.name)}</span>`;
                }
                html += `</div>`;
            }

            if (embed.title) {
                const titleStyle = embed.url ? 'color: #00aff4; text-decoration: none;' : 'color: #fff;';
                html += `<div style="${titleStyle} font-weight: 600; font-size: 16px; margin-bottom: 8px;">${escapeHtml(embed.title)}</div>`;
            }

            if (embed.description) {
                html += `<div style="color: #dcddde; font-size: 14px; margin-bottom: 8px; white-space: pre-wrap;">${escapeHtml(embed.description)}</div>`;
            }

            if (embed.fields && embed.fields.length > 0) {
                html += `<div style="margin-top: 12px;">`;
                embed.fields.forEach(field => {
                    html += `<div style="margin-bottom: 8px; ${field.inline ? 'display: inline-block; width: 48%; vertical-align: top; margin-right: 2%;' : ''}">`;
                    html += `<div style="color: #fff; font-weight: 600; font-size: 14px; margin-bottom: 4px;">${escapeHtml(field.name)}</div>`;
                    html += `<div style="color: #dcddde; font-size: 14px; white-space: pre-wrap;">${escapeHtml(field.value)}</div>`;
                    html += `</div>`;
                });
                html += `</div>`;
            }

            if (embed.thumbnail) {
                html += `<div style="margin-top: 12px;"><img src="${escapeHtml(embed.thumbnail.url)}" style="max-width: 80px; max-height: 80px; border-radius: 4px;" onerror="this.style.display='none';"></div>`;
            }

            if (embed.image) {
                html += `<div style="margin-top: 12px;"><img src="${escapeHtml(embed.image.url)}" style="max-width: 100%; border-radius: 4px;" onerror="this.style.display='none';"></div>`;
            }

            if (embed.footer || embed.timestamp) {
                html += `<div style="display: flex; align-items: center; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">`;
                if (embed.footer?.icon_url) {
                    html += `<img src="${escapeHtml(embed.footer.icon_url)}" style="width: 20px; height: 20px; border-radius: 50%;" onerror="this.style.display='none';">`;
                }
                html += `<span style="color: #72767d; font-size: 12px;">`;
                if (embed.footer?.text) {
                    html += escapeHtml(embed.footer.text);
                }
                if (embed.timestamp) {
                    if (embed.footer?.text) html += ' ‚Ä¢ ';
                    html += new Date(embed.timestamp).toLocaleString();
                }
                html += `</span></div>`;
            }

            html += `</div>`;
            return html;
        }

        window.testWebhook = async function() {
            const urlInput = document.getElementById('webhookUrlInput');
            const url = urlInput.value.trim();

            if (!url) {
                alert('Please enter a webhook URL first');
                return;
            }

            const embed = buildEmbedObject();
            await sendWebhook(url, embed, true);
        };

        window.testWebhookById = async function(id) {
            try {
                const snapshot = await database.ref(`webhooks/${id}`).once('value');
                if (snapshot.exists()) {
                    const webhook = snapshot.val();
                    await sendWebhook(webhook.url, webhook.embed, true);
                }
            } catch (error) {
                console.error('Error testing webhook:', error);
                alert('Error testing webhook: ' + error.message);
            }
        };

        async function sendWebhook(url, embed, isTest = false) {
            try {
                const payload = {
                    embeds: embed && Object.keys(embed).length > 0 ? [embed] : []
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    if (isTest) {
                        alert('‚úÖ Test message sent successfully!');
                    }
                    return true;
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('Error sending webhook:', error);
                alert('‚ùå Failed to send webhook: ' + error.message);
                return false;
            }
        }

        window.saveWebhook = async function() {
            const nameInput = document.getElementById('webhookNameInput');
            const urlInput = document.getElementById('webhookUrlInput');
            const errorDiv = document.getElementById('webhookEditorError');

            const name = nameInput.value.trim();
            const url = urlInput.value.trim();

            if (!name) {
                errorDiv.textContent = 'Webhook name is required';
                errorDiv.style.display = 'block';
                return;
            }

            if (!url) {
                errorDiv.textContent = 'Webhook URL is required';
                errorDiv.style.display = 'block';
                return;
            }

            if (!url.includes('discord.com/api/webhooks/')) {
                errorDiv.textContent = 'Invalid Discord webhook URL';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const embed = buildEmbedObject();
                const webhookData = {
                    name,
                    url,
                    embed: embed && Object.keys(embed).length > 0 ? embed : null,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };

                const id = window.currentEditingWebhookId || 'webhook_' + Date.now();
                await database.ref(`webhooks/${id}`).set(webhookData);
                alert('‚úÖ Webhook saved successfully!');
                hideWebhookEditor();
                loadWebhooks();
            } catch (error) {
                console.error('Error saving webhook:', error);
                errorDiv.textContent = 'Failed to save: ' + error.message;
                errorDiv.style.display = 'block';
            }
        };

        window.deleteWebhook = async function(id) {
            if (!confirm('Are you sure you want to delete this webhook?')) return;
            try {
                await database.ref(`webhooks/${id}`).remove();
                alert('‚úÖ Webhook deleted!');
                loadWebhooks();
            } catch (error) {
                console.error('Error deleting webhook:', error);
                alert('‚ùå Failed to delete: ' + error.message);
            }
        };

        // Update preview when inputs change
        document.addEventListener('DOMContentLoaded', () => {
            const embedInputs = ['embedTitleInput', 'embedDescriptionInput', 'embedUrlInput', 'embedColorInput', 
                                'embedAuthorNameInput', 'embedAuthorIconInput', 'embedFooterInput', 'embedFooterIconInput',
                                'embedThumbnailInput', 'embedImageInput', 'embedTimestampInput'];
            embedInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', updateEmbedPreview);
                    if (id === 'embedTimestampInput') {
                        input.addEventListener('change', function() {
                            if (this.value === 'custom') {
                                document.getElementById('embedTimestampCustomInput').style.display = 'block';
                            } else {
                                document.getElementById('embedTimestampCustomInput').style.display = 'none';
                            }
                            updateEmbedPreview();
                        });
                    }
                }
            });
        });

        // ============================================
        // TICKETS MANAGEMENT FUNCTIONS
        // ============================================
        async function loadTickets() {
            const content = document.getElementById('ticketsContent');
            const statusFilter = document.getElementById('ticketFilterStatus')?.value || 'all';
            const searchQuery = document.getElementById('ticketSearchInput')?.value.toLowerCase() || '';

            try {
                const snapshot = await database.ref('tickets').once('value');
                if (!snapshot.exists()) {
                    content.innerHTML = '<div class="empty-state"><div class="empty-state-text">No tickets found</div></div>';
                    return;
                }

                const tickets = snapshot.val();
                let entries = Object.entries(tickets)
                    .map(([id, ticket]) => ({ id, ...ticket }))
                    .sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));

                // Filter by status
                if (statusFilter !== 'all') {
                    entries = entries.filter(ticket => ticket.status === statusFilter);
                }

                // Filter by search
                if (searchQuery) {
                    entries = entries.filter(ticket => 
                        ticket.id.toLowerCase().includes(searchQuery) ||
                        ticket.subject.toLowerCase().includes(searchQuery) ||
                        (ticket.userIp && ticket.userIp.toLowerCase().includes(searchQuery))
                    );
                }

                if (entries.length === 0) {
                    content.innerHTML = '<div class="empty-state"><div class="empty-state-text">No tickets found</div></div>';
                    return;
                }

                let html = `
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Ticket ID</th>
                                <th>Subject</th>
                                <th>Status</th>
                                <th>User IP</th>
                                <th>Created</th>
                                <th>Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                entries.forEach(ticket => {
                    const createdDate = new Date(ticket.createdAt);
                    const updatedDate = new Date(ticket.updatedAt);
                    html += `
                        <tr>
                            <td style="font-family: monospace; font-size: 12px;">${escapeHtml(ticket.id)}</td>
                            <td>${escapeHtml(ticket.subject || 'No subject')}</td>
                            <td><span class="status-badge ${ticket.status === 'open' ? 'status-active' : 'status-inactive'}">${ticket.status || 'open'}</span></td>
                            <td style="font-family: monospace; font-size: 12px;">${escapeHtml(ticket.userIp || 'Unknown')}</td>
                            <td>${createdDate.toLocaleString()}</td>
                            <td>${updatedDate.toLocaleString()}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action btn-view" onclick="viewAdminTicket('${ticket.id}')">View</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                content.innerHTML = html;
            } catch (error) {
                console.error('Error loading tickets:', error);
                content.innerHTML = '<div class="empty-state"><div class="empty-state-text">Error loading tickets</div></div>';
            }
        }

        window.viewAdminTicket = async function(ticketId) {
            const modal = document.getElementById('adminTicketModal');
            const titleEl = document.getElementById('adminTicketTitle');
            const idEl = document.getElementById('adminTicketId');
            const messagesContainer = document.getElementById('adminTicketMessages');
            const closeBtn = document.getElementById('closeTicketBtn');

            try {
                const ticketSnapshot = await database.ref(`tickets/${ticketId}`).once('value');
                if (!ticketSnapshot.exists()) {
                    alert('Ticket not found');
                    return;
                }

                const ticket = ticketSnapshot.val();
                titleEl.textContent = ticket.subject || 'No Subject';
                idEl.textContent = ticket.id;
                
                if (ticket.status === 'closed') {
                    closeBtn.textContent = 'Reopen Ticket';
                } else {
                    closeBtn.textContent = 'Close Ticket';
                }

                // Load messages
                const messagesSnapshot = await database.ref(`ticketMessages/${ticketId}`).once('value');
                const messages = messagesSnapshot.exists() ? messagesSnapshot.val() : {};
                const messagesArray = Object.entries(messages)
                    .map(([timestamp, msg]) => ({ timestamp: parseInt(timestamp), ...msg }))
                    .sort((a, b) => a.timestamp - b.timestamp);

                renderAdminTicketMessages(messagesArray, messagesContainer);
                
                // Set up real-time listener
                database.ref(`ticketMessages/${ticketId}`).on('value', (snapshot) => {
                    const msgs = snapshot.exists() ? snapshot.val() : {};
                    const msgsArray = Object.entries(msgs)
                        .map(([timestamp, msg]) => ({ timestamp: parseInt(timestamp), ...msg }))
                        .sort((a, b) => a.timestamp - b.timestamp);
                    renderAdminTicketMessages(msgsArray, messagesContainer);
                });

                window.currentAdminTicketId = ticketId;
                modal.classList.add('active');
            } catch (error) {
                console.error('Error loading ticket:', error);
                alert('Error loading ticket: ' + error.message);
            }
        };

        function renderAdminTicketMessages(messages, container) {
            if (!container) return;

            if (messages.length === 0) {
                container.innerHTML = '<div style="color: #888; text-align: center; padding: 40px;">No messages yet</div>';
                return;
            }

            const html = messages.map(msg => {
                const date = new Date(msg.timestamp);
                const isUser = msg.sender === 'user';
                return `
                    <div style="margin-bottom: 16px; padding: 12px; border-radius: 4px; max-width: 80%; ${isUser ? 'background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3); margin-left: auto;' : 'background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.3);'}">
                        <div style="font-size: 11px; color: #888; margin-bottom: 4px; font-weight: 600;">${isUser ? 'User' : 'Admin'} ‚Ä¢ ${date.toLocaleString()}</div>
                        <div style="color: #e5e5e5; font-size: 14px; line-height: 1.5;">${escapeHtml(msg.message)}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }

        window.closeAdminTicketModal = function() {
            const modal = document.getElementById('adminTicketModal');
            if (window.currentAdminTicketId) {
                database.ref(`ticketMessages/${window.currentAdminTicketId}`).off();
            }
            window.currentAdminTicketId = null;
            modal.classList.remove('active');
        };

        window.sendAdminTicketMessage = async function() {
            const input = document.getElementById('adminTicketReplyInput');
            const message = input.value.trim();
            const ticketId = window.currentAdminTicketId;

            if (!message || !ticketId) return;

            if (!database) {
                alert('Database not initialized');
                return;
            }

            try {
                const messageData = {
                    ticketId,
                    message,
                    sender: 'admin',
                    timestamp: Date.now()
                };

                await database.ref(`ticketMessages/${ticketId}/${Date.now()}`).set(messageData);
                await database.ref(`tickets/${ticketId}/updatedAt`).set(Date.now());

                input.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message: ' + error.message);
            }
        };

        window.closeAdminTicket = async function() {
            const ticketId = window.currentAdminTicketId;
            if (!ticketId) return;

            if (!confirm('Are you sure you want to change the ticket status?')) return;

            try {
                const ticketSnapshot = await database.ref(`tickets/${ticketId}`).once('value');
                if (!ticketSnapshot.exists()) return;

                const ticket = ticketSnapshot.val();
                const newStatus = ticket.status === 'closed' ? 'open' : 'closed';

                await database.ref(`tickets/${ticketId}/status`).set(newStatus);
                await database.ref(`tickets/${ticketId}/updatedAt`).set(Date.now());

                alert(`‚úÖ Ticket ${newStatus === 'closed' ? 'closed' : 'reopened'} successfully!`);
                loadTickets();
                viewAdminTicket(ticketId); // Refresh view
            } catch (error) {
                console.error('Error closing ticket:', error);
                alert('Failed to update ticket: ' + error.message);
            }
        };

        window.saveTicketTranscript = async function() {
            const ticketId = window.currentAdminTicketId;
            if (!ticketId) return;

            try {
                const ticketSnapshot = await database.ref(`tickets/${ticketId}`).once('value');
                const messagesSnapshot = await database.ref(`ticketMessages/${ticketId}`).once('value');

                if (!ticketSnapshot.exists()) {
                    alert('Ticket not found');
                    return;
                }

                const ticket = ticketSnapshot.val();
                const messages = messagesSnapshot.exists() ? messagesSnapshot.val() : {};
                const messagesArray = Object.entries(messages)
                    .map(([timestamp, msg]) => ({ timestamp: parseInt(timestamp), ...msg }))
                    .sort((a, b) => a.timestamp - b.timestamp);

                let transcript = `TICKET TRANSCRIPT\n`;
                transcript += `==================\n\n`;
                transcript += `Ticket ID: ${ticket.id}\n`;
                transcript += `Subject: ${ticket.subject || 'No subject'}\n`;
                transcript += `Status: ${ticket.status}\n`;
                transcript += `User IP: ${ticket.userIp || 'Unknown'}\n`;
                transcript += `Created: ${new Date(ticket.createdAt).toLocaleString()}\n`;
                transcript += `Updated: ${new Date(ticket.updatedAt).toLocaleString()}\n\n`;
                transcript += `MESSAGES\n`;
                transcript += `========\n\n`;

                messagesArray.forEach(msg => {
                    const date = new Date(msg.timestamp);
                    transcript += `[${date.toLocaleString()}] ${msg.sender.toUpperCase()}: ${msg.message}\n\n`;
                });

                // Create download
                const blob = new Blob([transcript], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ticket-${ticket.id}-transcript.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert('‚úÖ Transcript saved successfully!');
            } catch (error) {
                console.error('Error saving transcript:', error);
                alert('Failed to save transcript: ' + error.message);
            }
        };
    </script>
</body>
</html>

